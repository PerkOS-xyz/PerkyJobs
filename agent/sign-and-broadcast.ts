import { createWalletClient, createPublicClient, http, defineChain } from "viem";
import { privateKeyToAccount } from "viem/accounts";
import { readFileSync } from "fs";

const celo = defineChain({
  id: 42220,
  name: "Celo",
  nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
  rpcUrls: { default: { http: ["https://forno.celo.org"] } },
});

// Load deployer wallet
const keyHex = readFileSync("/Users/zknexus/.openclaw/wallets/alice", "utf8").trim();
const account = privateKeyToAccount(keyHex.startsWith("0x") ? keyHex as `0x${string}` : `0x${keyHex}`);
console.log("Wallet:", account.address);

const publicClient = createPublicClient({ chain: celo, transport: http() });
const walletClient = createWalletClient({ account, chain: celo, transport: http() });

// ERC-8004 Identity TX
const erc8004Tx = {
  to: "0x8004A169FB4a3325136EB29fA0ceB6D2e539a432" as `0x${string}`,
  data: "0xf2c298be0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000007868747470733a2f2f73656c66636c61772e61692f6170692f73656c66636c61772f76312f6167656e742f4d436f77425159444b32567741794541683441755a514b734d333841532b69624e76717874377a66675177736b4b544c70667369646861424465593d2f726567697374726174696f6e2e6a736f6e0000000000000000" as `0x${string}`,
  gas: 300000n,
};

// PERKY Token deploy TX
const tokenTxData = "0x608060405234801562000010575f80fd5b5060405162000a0d38038062000a0d833981016040819052620000339162000162565b5f6200004084826200025a565b5060016200004f83826200025a565b506002819055335f818152600360209081526040808320859055518481527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef910160405180910390a350505062000326565b634e487b7160e01b5f52604160045260245ffd5b5f82601f830112620000c5575f80fd5b81516001600160401b0380821115620000e257620000e2620000a1565b604051601f8301601f19908116603f011681019082821181831017156200010d576200010d620000a1565b81604052838152602092508660208588010111156200012a575f80fd5b5f91505b838210156200014d57858201830151818301840152908201906200012e565b5f602085830101528094505050505092915050565b5f805f6060848603121562000175575f80fd5b83516001600160401b03808211156200018c575f80fd5b6200019a87838801620000b5565b94506020860151915080821115620001b0575f80fd5b50620001bf86828701620000b5565b925050604084015190509250925092565b600181811c90821680620001e557607f821691505b6020821081036200020457634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200025557805f5260205f20601f840160051c81016020851015620002315750805b601f840160051c820191505b8181101562000252575f81556001016200023d565b50505b505050565b81516001600160401b03811115620002765762000276620000a1565b6200028e81620002878454620001d0565b846200020a565b602080601f831160018114620002c4575f8415620002ac5750858301515b5f19600386901b1c1916600185901b1785556200031e565b5f85815260208120601f198616915b82811015620002f457888601518255948401946001909101908401620002d3565b50858210156200031257878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b6106d980620003345f395ff3fe608060405234801561000f575f80fd5b5060043610610090575f3560e01c8063313ce56711610063578063313ce567146100ff57806370a082311461011957806395d89b4114610138578063a9059cbb14610140578063dd62ed3e14610153575f80fd5b806306fdde0314610094578063095ea7b3146100b257806318160ddd146100d557806323b872dd146100ec575b5f80fd5b61009c61017d565b6040516100a99190610518565b60405180910390f35b6100c56100c036600461057f565b610208565b60405190151581526020016100a9565b6100de60025481565b6040519081526020016100a9565b6100c56100fa3660046105a7565b610274565b610107601281565b60405160ff90911681526020016100a9565b6100de6101273660046105e0565b60036020525f908152604090205481565b61009c61042a565b6100c561014e36600461057f565b610437565b6100de610161366004610600565b600460209081525f928352604080842090915290825290205481565b5f805461018990610631565b80601f01602080910402602001604051908101604052809291908181526020018280546101b590610631565b80156102005780601f106101d757610100808354040283529160200191610200565b820191905f5260205f20905b8154815290600101906020018083116101e357829003601f168201915b505050505081565b335f8181526004602090815260408083206001600160a01b038716808552925280832085905551919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925906102629086815260200190565b60405180910390a35060015b92915050565b6001600160a01b0383165f908152600360205260408120548211156102d75760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b60448201526064015b60405180910390fd5b6001600160a01b0384165f9081526004602090815260408083203384529091529020548211156103425760405162461bcd60e51b8152602060048201526016602482015275496e73756666696369656e7420616c6c6f77616e636560501b60448201526064016102ce565b6001600160a01b0384165f9081526004602090815260408083203384529091528120805484929061037490849061067d565b90915550506001600160a01b0384165f90815260036020526040812080548492906103a090849061067d565b90915550506001600160a01b0383165f90815260036020526040812080548492906103cc908490610690565b92505081905550826001600160a01b0316846001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161041891815260200190565b60405180910390a35060019392505050565b6001805461018990610631565b335f9081526003602052604081205482111561048c5760405162461bcd60e51b8152602060048201526014602482015273496e73756666696369656e742062616c616e636560601b60448201526064016102ce565b335f90815260036020526040812080548492906104aa90849061067d565b90915550506001600160a01b0383165f90815260036020526040812080548492906104d6908490610690565b90915550506040518281526001600160a01b0384169033907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90602001610262565b5f602080835283518060208501525f5b8181101561054457858101830151858201604001528201610528565b505f604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b038116811461057a575f80fd5b919050565b5f8060408385031215610590575f80fd5b61059983610564565b946020939093013593505050565b5f805f606084860312156105b9575f80fd5b6105c284610564565b92506105d060208501610564565b9150604084013590509250925092565b5f602082840312156105f0575f80fd5b6105f982610564565b9392505050565b5f8060408385031215610611575f80fd5b61061a83610564565b915061062860208401610564565b90509250929050565b600181811c9082168061064557607f821691505b60208210810361066357634e487b7160e01b5f52602260045260245ffd5b50919050565b634e487b7160e01b5f52601160045260245ffd5b8181038181111561026e5761026e610669565b8082018082111561026e5761026e61066956fea26469706673582212200b3452caed3b8e7be21c901099adf56476587c0698ac9d5248bf10d7781f056e64736f6c63430008180033000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000d3c21bcecceda100000000000000000000000000000000000000000000000000000000000000000000095065726b794a6f6273000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055045524b59000000000000000000000000000000000000000000000000000000" as `0x${string}`;

async function main() {
  const nonce = await publicClient.getTransactionCount({ address: account.address });
  console.log("Current nonce:", nonce);
  const balance = await publicClient.getBalance({ address: account.address });
  console.log("Balance:", Number(balance) / 1e18, "CELO");

  // TX 1: ERC-8004 Identity Registration
  console.log("\n=== TX 1: Register ERC-8004 Identity ===");
  const hash1 = await walletClient.sendTransaction({
    ...erc8004Tx,
    nonce,
  });
  console.log("ERC-8004 TX hash:", hash1);
  const receipt1 = await publicClient.waitForTransactionReceipt({ hash: hash1 });
  console.log("ERC-8004 status:", receipt1.status);
  console.log("Gas used:", receipt1.gasUsed.toString());

  // TX 2: Deploy PERKY Token
  console.log("\n=== TX 2: Deploy PERKY Token ===");
  const hash2 = await walletClient.sendTransaction({
    data: tokenTxData,
    gas: 750000n,
    nonce: nonce + 1,
  });
  console.log("Token deploy TX hash:", hash2);
  const receipt2 = await publicClient.waitForTransactionReceipt({ hash: hash2 });
  console.log("Token deploy status:", receipt2.status);
  console.log("Token address:", receipt2.contractAddress);
  console.log("Gas used:", receipt2.gasUsed.toString());

  // Save token address for next steps
  if (receipt2.contractAddress) {
    console.log("\n=== SAVE THESE ===");
    console.log("ERC-8004 TX:", hash1);
    console.log("Token TX:", hash2);
    console.log("Token address:", receipt2.contractAddress);
  }
}

main().catch(console.error);
